<div class="cardpad card">
    <div class="card-body">
        <div class="row">
            <div class="col-sm-3">
                <span data-toggle="popover" data-trigger="hover" data-placement="top"
                      data-content="Current mined block height">
                        <i class="fa fa-bars"></i> Height: <span id="blockchainHeight" data-height="0"></span>
                    </span>
            </div>
            <div class="col-sm-3">
                <span data-toggle="popover" data-trigger="hover" data-placement="top"
                      data-content="Difficulty of the current mined block">
                        <i class="fas fa-microchip"></i> Next Difficulty: <span id="nextDifficulty"></span>
                    </span>
            </div>
            <div class="col-sm-3">
                <span data-toggle="popover" data-trigger="hover" data-placement="top"
                      data-content="Based on the current mined block">
                        <i class="fas fa-tachometer-alt"></i> Global Hash Rate: <span id="networkHashrate"></span>
                    </span>
            </div>
            <div class="col-sm-3">
                <span data-toggle="popover" data-trigger="hover" data-placement="top"
                      data-content="On the last visible blocks">
                        <i class="fas fa-percent"></i></i> Average Hash Rate: <span id="averageHashrate"></span>
                    </span>
            </div>
        </div>

    </div>
    <div class="input-group mb-3 search">
        <input id="txt_search" class="form-control" placeholder="Search for block number / block hash / hash transaction">
        <div class="input-group-append">
            <button id="btn_search" class="btn btn-outline-secondary" type="button"><i class="fa fa-search"></i> Search
            </button>
        </div>
    </div>
</div>



<div class="cardpad card">
    <div class="card-header">
        Lasts <span id="nb_blocks"></span> blocks found
    </div>
    <div id="block_table" class="card-body table-responsive">
        <table class="table table-hover">
            <thead>
            <tr>
                <th><i class="fa fa-bars"></i> Height</th>
                <th><i class="fas fa-microchip"></i> Difficulty</th>
                <th><i class="fas fa-ellipsis-h"></i> Block Hash</th>
                <th><i class="far fa-clock"></i> Time found</th>
                <th><i class="far fa-hdd"></i> Size</th>
                <th><i class="fas fa-exchange-alt"></i> tx</th>
            </tr>
            </thead>
            <tbody id="blocks_rows">

            </tbody>
        </table>
    </div>
</div>
<p class="text-center">
    <button type="button" class="btn btn-default invisible" id="loadMoreBlocks">Load More</button>
</p>
<script>
    // Current page handlers (whe should know lastMinedBlockHeader)
    currentPage = {
        destroy: function () {
            if (xhrGetCurrentMinedBlock) xhrGetCurrentMinedBlock.abort();
            if (xhrGetLastBlocks) xhrGetLastBlocks.abort();
        },
        update: function () {
            if (parseInt(lastMinedBlockHeader.block_header.height, 10) !== parseInt($('#blockchainHeight').attr('data-height'), 10)) {
                $('#blockchainHeight').attr('data-height', lastMinedBlockHeader.block_header.height);
                getCurrentMinedBlock();
                getBlocks(lastMinedBlockHeader.block_header.height);
            }
        }
    };

    // Current page functions.

    var xhrGetCurrentMinedBlock;
    // get last block template (current mining block)
    function getCurrentMinedBlock() {
        if (xhrGetCurrentMinedBlock) xhrGetCurrentMinedBlock.abort();
        xhrGetCurrentMinedBlock = $.ajax({
            url: api + '/json_rpc',
            method: "POST",
            data: JSON.stringify({
                jsonrpc: "2.0",
                id: "2",
                method: "getblocktemplate",
                params: {
                    reserve_size: 0,
                    wallet_address: "ir3AmNVgaquFesnDNNBkZMGa8vqHhwvqX4JHKuHFj9DQSwDsr4kNunrWhXs1eG34PnDWx7cbn8nJ9bN2gnHC99eA1kceFnJ1k"
                }
            }),
            dataType: 'json',
            cache: 'false'
        })
            .done(function (data) {
                if (data.hasOwnProperty('result')) {
                    currentMinedBlock = data.result;
                    updateText('networkHashrate', getReadableHashRateString(currentMinedBlock.difficulty / coinDifficultyTarget));
                    updateText('nextDifficulty', currentMinedBlock.difficulty.toString());
                    updateText('blockchainHeight', currentMinedBlock.height);
                } else {
                    updateText('alert_text', data.error.message);
                    $('.alert_wrapper').removeClass('invisible');
                    $('#loading').hide();
                }
            })
            .fail(function (xhrGetCurrentMinedBlock, textStatus) {
                if (textStatus != "abort") {
                    updateText('alert_text', 'While getting current mined block : ' + textStatus);
                    $('.alert_wrapper').removeClass('invisible');
                    $('#loading').hide();
                }
            });
    }


    // Get last 31 blocks
    $('#loadMoreBlocks').click(function() {
        getBlocks($('#blocks_rows').children().last().data('height'));
    });

    var xhrGetLastBlocks;
    function getBlocks(heightAsked) {
        if (xhrGetLastBlocks) xhrGetLastBlocks.abort();
        xhrGetLastBlocks = $.ajax({
            url: api + '/json_rpc',
            method: "POST",
            data: JSON.stringify({
                jsonrpc: "2.0",
                id: "4",
                method: "f_blocks_list_json",
                params: {
                    height:heightAsked
                }
            }),
            dataType: 'json',
            cache: 'false'
        })
            .done(function (data) {
                if (data.hasOwnProperty('result')) {
                    lastBlocksList = data.result.blocks;
                    renderBlocks(lastBlocksList);
                    $('#loading').hide();
                } else {
                    updateText('alert_text', data.error.message);
                    $('.alert_wrapper').removeClass('invisible');
                    $('#loading').hide();
                }
            })
            .fail(function (xhrGetLastBlocks, textStatus) {
                if (textStatus != "abort") {
                    updateText('alert_text', 'While getting last blocs list : ' + textStatus);
                    $('.alert_wrapper').removeClass('invisible');
                    $('#loading').hide();
                }
            });
    }


    // Handle Blocks list
    var sumDiff = 0;
    var totalblocks = 0;
    function renderBlocks(blocksResults){
        $blocksRows = $('#blocks_rows');
        for ( i = 0; i < blocksResults.length; i ++){
            block = blocksResults[i];
            blockJson = JSON.stringify(block);
            existingRow = document.getElementById('blockRow' + block.height);
            // console.warn('existingRow : ' + existingRow + ' i : ' + i);
            if (existingRow && existingRow.getAttribute('data-json') !== blockJson){
                $(existingRow).replaceWith(getBlockRowElement(block, blockJson));
            }
            else if (!existingRow){
                blockElement = getBlockRowElement(block, blockJson);
                inserted = false;
                rows = $blocksRows.children().get();
                for (f = 0; f < rows.length; f++) {
                    bHeight = parseInt(rows[f].getAttribute('data-height'));
                    if (bHeight < block.height){
                        inserted = true;
                        $(rows[f]).before(blockElement);
                        break;
                    }
                }
                if (!inserted)
                    $blocksRows.append(blockElement);
            }
            totalblocks++;
            sumDiff += blocksResults[i].difficulty;
        }
        console.warn('total blocks loaded :' + totalblocks);
        console.warn('sumDiff :' + sumDiff);
        averageHashRate = sumDiff / totalblocks;
        updateText('averageHashrate', getReadableHashRateString(averageHashRate / coinDifficultyTarget));
        updateText('nb_blocks', totalblocks);
        $('#loadMoreBlocks').removeClass('invisible');
    }

    function getBlockRowElement(block,jsonString) {

        row = document.createElement('tr');
        row.setAttribute('data-json', jsonString);
        row.setAttribute('data-height', block.height);
        row.setAttribute('id', 'blockRow' + block.height);
        row.setAttribute('title', block.hash);

        columns =
            '<td>' + block.height + '</td>' +
            '<td>' + block.difficulty + '</td>' +
            '<td>' + formatBlockLink(block.hash) + '</td>' +
            '<td>' + formatDate(block.timestamp) + '</td>' +
            '<td>' + block.cumul_size + '</td>' +
            '<td>' + block.tx_count + '</td>';
        row.innerHTML = columns;
        return row;
    }

    // enable popover
    $(document).ready(function () {
        $('[data-toggle="popover"]').popover({})
    });
</script>