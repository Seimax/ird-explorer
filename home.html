<div class="d-none d-lg-block">
    <img class="logo img-fluid" src="images/pool.png" alt="IRD Iridium cryptonote coin logo">
</div>


<div class="cardpad card">
    <div class="card-header">
        Network status
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-sm-6">
                <p><i class="fas fa-tachometer-alt"></i> Hashrate: <span id="networkHashrate"></span></p>
                <p><i class="fa fa-bars"></i> Height: <span id="blockchainHeight"></span></p>
                <!--<p><i class="fas fa-tachometer-alt"></i> Global Hash Rate: <span id="networkHashrate"></span></p>-->
                <p><i class="far fa-clock"></i> Last block Found: <span id="networkLastBlockFound"></span></p>
                <!--<p><i class="far fa-clock"></i> Timestamp: <span id="networkLastBlockFoundTS"></span></p>-->
                <!--<p><i class="fa fa-unlock-alt"></i> Difficulty: <span id="networkDifficulty"></span></p>-->
                <!--<p><i class="fa fa-bars"></i> Blockchain Height: <span id="blockchainHeight"></span></p>-->
                <p><i class="fas fa-piggy-bank"></i> Last Reward: <span id="networkLastReward"></span></p>
                <!--<p><i class="fas fa-th"></i> Last Hash: <a id="lastHash" target="_blank"></a></p>-->
            </div>
            <div class="col-sm-6">
                <p><i class="far fa-money-bill-alt"></i> Current Supply: <span id="alreadyGeneratedCoins"></span></p>
                <p><i class="fas fa-university"></i> Total emission: <span id="supplypercent"></span></p>
                <p><i class="fas fa-exchange-alt"></i> Total transactions: <span
                        id="alreadyGeneratedTransactions"></span></p>
                <p><i class="fas fa-code-branch"></i> Blockchain version: <span id="major_version"></span></p>
            </div>
        </div>
    </div>
</div>

<div class="cardpad card">
    <div class="card-header">
        <span id="nb_tx"></span>
    </div>
    <div id="tx_table" class="card-body table-responsive">
        <table class="table table-hover">
            <thead>
            <tr>
                <th><i class="fas fa-ellipsis-h"></i> Transaction hash</th>
                <th><i class="fas fa-donate"></i> Fee</th>
                <th><i class="fas fa-dollar-sign"></i> Total Amount</th>
                <th><i class="far fa-hdd"></i> Size</th>
            </tr>
            </thead>
            <tbody id="transactions_rows">

            </tbody>
        </table>
    </div>
</div>

<div class="cardpad card">
    <div class="card-header">
        Lasts blocks found <span id="nb_blocks"></span>
    </div>
    <div id="block_table" class="card-body table-responsive">
        <table class="table table-hover">
            <thead>
            <tr>
                <th><i class="fa fa-bars"></i> Height</th>
                <th><i class="fas fa-microchip"></i> Difficulty</th>
                <th><i class="fas fa-ellipsis-h"></i> Block Hash</th>
                <th><i class="far fa-clock"></i> Time found</th>
                <th><i class="far fa-hdd"></i> Size</th>
                <th><i class="fas fa-piggy-bank"></i> Reward</th>
                <th><i class="far fa-hdd"></i> tx</th>
            </tr>
            </thead>
            <tbody id="blocks_rows">

            </tbody>
        </table>
    </div>
</div>

<script>
    currentPage = {
        destroy: function () {
            $('#networkLastBlockFound').timeago('dispose');
            if (xhrGetLastBlockDetails) xhrGetLastBlockDetails.abort();
            if (xhrGetTxPool) xhrGetTxPool.abort();
            if (xhrGetBlocks) xhrGetBlocks.abort();
        },
        init: function () {
            $('#tx_table').hide();

            // Get last block details
            if (xhrGetLastBlockDetails) xhrGetLastBlockDetails.abort();
            $('#loading').show();
            xhrGetLastBlockDetails = $.ajax({
                url: api,
                method: "POST",
                data: JSON.stringify({
                    jsonrpc: "2.0",
                    id: "2",
                    method: "f_block_json",
                    params: {
                        hash: lastBlock.block_header.hash
                    }
                }),
                dataType: 'json',
                cache: 'false'
            })
                .done(function (data) {
                    // todo : check result.status OK
                    lastBlockDetail = data.result;
                    currentPage.update_network();
                    $('#loading').hide();
                });

            // Get mempool details
            if (xhrGetTxPool) xhrGetTxPool.abort();
            $('#loading').show();
            xhrGetTxPool = $.ajax({
                url: api,
                method: "POST",
                data: JSON.stringify({
                    jsonrpc: "2.0",
                    id: "3",
                    method: "f_on_transactions_pool_json"
                }),
                dataType: 'json',
                cache: 'false'
            })
                .done(function (data) {
                    // todo : check result.status OK
                    txPool = data.result;
                    currentPage.update_tx_pool();
                    $('#loading').hide();
                });

            // Get last 30 blocks
            if (xhrGetBlocks) xhrGetBlocks.abort();
            $('#loading').show();
            xhrGetBlocks = $.ajax({
                url: api,
                method: "POST",
                data: JSON.stringify({
                    jsonrpc: "2.0",
                    id: "4",
                    method: "f_blocks_list_json",
                    params: {
                        height: lastBlock.block_header.height
                    }
                }),
                dataType: 'json',
                cache: 'false'
            })
                .done(function (data) {
                    // todo : check result.status OK
                    // todo add reward in f_blocks_list_json method
                    blocksList = data.result.blocks;
                    currentPage.update_block_list();
                    $('#loading').hide();
                });

        },
        update_network: function () {
            // check if lastblock status ok
            updateText('networkHashrate', getReadableHashRateString(lastBlock.block_header.difficulty / coinDifficultyTarget));
            $('#networkLastBlockFound').timeago('update', new Date(lastBlock.block_header.timestamp * 1000).toISOString());
            // updateText('networkLastBlockFoundTS', lastBlock.block_header.timestamp.toString());
            // updateText('networkDifficulty', lastBlock.block_header.difficulty.toString());
            updateText('blockchainHeight', lastBlock.block_header.height.toString());
            updateText('networkLastReward', getReadableCoins(lastBlock.block_header.reward, 2));
            // updateText('lastHash', lastBlock.block_header.hash.substr(0, 13) + '...').setAttribute('href', getBlockchainUrl(lastBlock.block_header.hash));
            updateText('alreadyGeneratedCoins', shortenLargeNumber(lastBlockDetail.block.alreadyGeneratedCoins / coinUnits, 6, 0));
            updateText('supplypercent', (lastBlockDetail.block.alreadyGeneratedCoins / 25000000000000).toFixed(2) + ' %');
            updateText('alreadyGeneratedTransactions', shortenLargeNumber(lastBlockDetail.block.alreadyGeneratedTransactions, 3, 1));
            updateText('major_version', lastBlock.block_header.major_version.toString());
        },
        update_tx_pool: function () {
            if (txPool.transactions.length > 0) {
                $('#tx_table').show();
            } else {
                $('#tx_table').hide();
            }
            updateText('nb_tx', txPool.transactions.length.toString() + ' transaction' + (txPool.transactions.length > 1 ? 's' : '') + ' in pool');
            renderTransactions(txPool.transactions)
        },
        update_block_list: function () {
            updateText('nb_blocks', ': ' + blocksList.length.toString());
            renderBlocks(blocksList);
        }
    };

    function getTransactionCells(transaction) {
        return '<td>' + transaction.hash + '</td>' +
            '<td>' + getReadableCoins(transaction.fee, 4, true) + '</td>' +
            '<td>' + getReadableCoins(transaction.amount_out, 2, false) + '</td>' +
            '<td>' + transaction.size + '</td>';
    }

    function getTransactionRowElement(transaction, jsonString) {
        var row = document.createElement('tr');
        row.setAttribute('data-json', jsonString);
        row.setAttribute('data-hash', transaction.hash);
        row.setAttribute('id', 'transactionRow' + transaction.hash);
        row.innerHTML = getTransactionCells(transaction);
        return row;
    }

    function renderTransactions(transactionResults) {
        var $transactionsRows = $('#transactions_rows');
        for (var i = 0; i < transactionResults.length; i++) {
            var transaction = transactionResults[i];
            var transactionJson = JSON.stringify(transaction);
            var existingRow = document.getElementById('transactionRow' + transaction.hash);
            if (existingRow && existingRow.getAttribute('data-json') !== transactionJson) {
                $(existingRow).replaceWith(getTransactionRowElement(transaction, transactionJson));
            }
            else if (!existingRow) {
                var transactionElement = getTransactionRowElement(transaction, transactionJson);
                $transactionsRows.append(transactionElement);
            }
        }
    }

    function getBlockRowElement(block, jsonString) {

        var row = document.createElement('tr');
        row.setAttribute('data-json', jsonString);
        row.setAttribute('data-height', block.height);
        row.setAttribute('id', 'blockRow' + block.height);
        row.setAttribute('title', block.hash);

        var columns =
            '<td>' + block.height + '</td>' +
            '<td>' + block.difficulty + '</td>' +
            '<td>' + formatBlockLink(block.hash) + '</td>' +
            '<td>' + formatDate(block.timestamp) + '</td>' +
            '<td>' + 'reward' + '</td>' +
            '<td>' + block.cumul_size + '</td>' +
            '<td>' + block.tx_count + '</td>';

        row.innerHTML = columns;

        return row;
    }

    function renderBlocks(blocksList) {
        var $blocksRows = $('#blocks_rows');
        for (var i = 0; i < blocksList.length; i++) {
            var block = blocksList[i];
            var blockJson = JSON.stringify(block);
            var existingRow = document.getElementById('blockRow' + block.height);
            if (existingRow && existingRow.getAttribute('data-json') !== blockJson) {
                $(existingRow).replaceWith(getBlockRowElement(block, blockJson));
            }
            else if (!existingRow) {
                var blockElement = getBlockRowElement(block, blockJson);
                var inserted = false;
                var rows = $blocksRows.children().get();
                for (var f = 0; f < rows.length; f++) {
                    var bHeight = parseInt(rows[f].getAttribute('data-height'));
                    if (bHeight < block.height) {
                        inserted = true;
                        $(rows[f]).before(blockElement);
                        break;
                    }
                }
                if (!inserted)
                    $blocksRows.append(blockElement);
            }
        }
    }
</script>